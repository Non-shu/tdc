<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.repository.mybatis.ApprovalDocumentMapper">

  <resultMap id="DocMap" type="com.example.demo.domain.ApprovalDocumentVO">
    <id     property="docId"     column="doc_id"/>
    <result property="formCode"  column="form_code"/>
    <result property="title"     column="title"/>
    <result property="content"   column="content"/>
    <result property="status"    column="status"
            javaType="com.example.demo.domain.ApprovalStatus"
            typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
    <result property="createdBy" column="created_by"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <insert id="insert" parameterType="com.example.demo.domain.ApprovalDocumentVO"
          useGeneratedKeys="true" keyProperty="docId">
    INSERT INTO approval_document (form_code, title, content, status, created_by)
    VALUES (#{formCode}, #{title}, #{content},
            #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{createdBy})
  </insert>

  <select id="findById" parameterType="long" resultMap="DocMap">
    SELECT doc_id, form_code, title, content, status, created_by, created_at
    FROM approval_document
    WHERE doc_id = #{docId}
  </select>

  <select id="findMyDrafts" resultMap="DocMap">
    SELECT doc_id, form_code, title, content, status, created_by, created_at
    FROM approval_document
    WHERE created_by = #{userId}
      AND status = 'DRAFT'
    ORDER BY doc_id DESC
  </select>

  <select id="findByStatus" resultMap="DocMap">
    SELECT doc_id, form_code, title, content, status, created_by, created_at
    FROM approval_document
    WHERE created_by = #{userId}
      AND status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler}
    ORDER BY doc_id DESC
  </select>

  <update id="updateTemp" parameterType="com.example.demo.domain.ApprovalDocumentVO">
    UPDATE approval_document
       SET form_code = #{formCode},
           title     = #{title},
           content   = #{content}
     WHERE doc_id = #{docId}
       AND status = 'DRAFT'
  </update>
  
  <update id="updateStatus">
  UPDATE approval_document SET status = #{status} WHERE doc_id = #{docId}
</update>

<select id="findHeader" resultType="map">
  SELECT d.doc_id,
         d.title,
         d.content                 AS contentHtml,
         d.status,
         d.created_at,
         e.emp_nm                  AS drafter_name
  FROM approval_document d
  JOIN emp e ON e.emp_id = d.created_by
  WHERE d.doc_id = #{docId}
</select>

</mapper>
