<!-- templates/views/approval/receive.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<section layout:fragment="content">
  <!-- Toast UI Grid -->
  <link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css">
  <script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>

  <style>
    /* 페이지 폭을 좀 더 넓게 (필요시 수치 조절) */
    .page { max-width: 1440px; margin: 24px auto; padding: 0 16px; }

    .toolbar { display: flex; gap: 8px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    .toolbar input, .toolbar select { height: 32px; padding: 0 8px; }

    /* 그리드 높이 여유 */
    #grid { height: 720px; border-radius: 10px; overflow: hidden; }
  </style>

  <div class="page">
    <h3 class="mb-2">수신함</h3>

    <div class="toolbar">
      <select id="f-status" title="상태">
        <option value="">상태: 전체</option>
        <option value="SUBMIT">대기</option>
        <option value="APPROVED">승인</option>
        <option value="REJECTED">반려</option>
      </select>
      <select id="f-read" title="읽음">
        <option value="">읽음: 전체</option>
        <option value="N">안읽음</option>
        <option value="Y">읽음</option>
      </select>
      <input id="f-from" type="date"><span>~</span><input id="f-to" type="date">
      <input id="f-q" type="text" placeholder="제목/기안자 검색" style="min-width:220px">
      <button id="btn-search" type="button" class="btn btn-outline-primary btn-sm">조회</button>
    </div>

    <div id="grid"></div>
  </div>

  <script>
    // 날짜 포맷 보정 (서버가 'yyyy-MM-dd HH:mm' 주면 그대로 쓰고, ISO면 T 제거)
    const fmt = (s) => s ? String(s).replace('T',' ').slice(0,16) : '';

    // 진행상황 칼럼 포매터
    function progressCell(row) {
      // 내가 처리했으면 처리 시각 노출
      if (row.actedAt) return `<span class="text-body-secondary">${fmt(row.actedAt)}</span>`;
      // 내 차례면 '미결'(빨간)
      if (row.myTurn === 'Y') return `<b style="color:#ef4444">미결</b>`;
      // 그 외는 '대기' (원치 않으면 '-' 로 바꿔도 됨)
      return `<span class="text-secondary">대기</span>`;
    }

    const grid = new tui.Grid({
        el: document.getElementById('grid'),
        bodyHeight: 'fitToParent',
        rowHeight: 40,
        pageOptions: { perPage: 20 },
        header: { height: 40 },
        rowHeaders: ['checkbox'],
        columns: [
          { header: '상태', name: 'statusNm', width: 90, align: 'center' },
          {
            header: '제목', name: 'title', minWidth: 360,
            formatter: ({ value, row }) => {
              const f = row.attachCnt > 0 ? ` <span style="color:#64748b">(${row.attachCnt}개)</span>` : '';
              const title = value ?? '';
              return `<a href="/approval/${row.docId}" style="text-decoration:none;color:#0d6efd">${title}</a>${f}`;
            }
          },
          { header: '기안자', name: 'drafterName', width: 140 },
          { header: '상신일자',   name: 'notifiedAt', width: 160 },
          // ▼ 여기 변경 (읽음 → 진행상황)
          {
            header: '진행상황', name: 'actedAt', width: 140, align: 'center',
            formatter: ({ row }) =>
              row.actedAt
                ? row.actedAt
                : (row.myTurn === 'Y' ? '<b style="color:#ef4444">미결</b>' : '-')
          }
        ],
        data: { api: { readData: { url: '/api/receive', method: 'GET' } } }
      });
    // 더블클릭 시 상세 이동
    grid.on('dblclick', ev => {
      const r = grid.getRow(ev.rowKey);
      if (r && r.docId != null) location.href = `/approval/${r.docId}`;
    });

    // 파라미터 구성 & 로드
    function params(page = 1) {
      return {
        page,
        perPage: grid.getPagination()._options.itemsPerPage,
        status:  document.getElementById('f-status').value,
        read:    document.getElementById('f-read').value,
        from:    document.getElementById('f-from').value,
        to:      document.getElementById('f-to').value,
        keyword: document.getElementById('f-q').value
      };
    }
    function reload(page = 1) {
      grid.readData(page, params(page), true);
    }

    // 이벤트
    document.getElementById('btn-search').addEventListener('click', () => reload(1));
    document.getElementById('f-q').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') reload(1);
    });

    // 첫 로드
    reload(1);
  </script>
</section>

</html>
