<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<section layout:fragment="content">
  <div class="container-lg px-4 py-4">
    <h3 class="mb-3">결재 작성</h3>

    <form id="approvalForm" th:action="@{/approval/write}" method="post" enctype="multipart/form-data">
      <!-- CSRF (있으면 자동 주입) -->
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

      <!-- 서버전송 히든 -->
      <input type="hidden" id="apprformId" name="apprformId"/>
      <input type="hidden" id="approverIds" name="approverIds"/>
      <input type="hidden" id="docHtml" name="docHtml"/>

      <div class="row g-3">
        <!-- 본문 카드 -->
        <div class="col-12 col-xl-9">
          <div class="card">
            <div class="card-body">
              <!-- 상단 툴 -->
              <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                <button type="button" class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal" data-bs-target="#formSelectModal">
                  양식 선택
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm"
                        data-bs-toggle="modal" data-bs-target="#apprLineModal">
                  결재선 지정
                </button>
                <span class="vr mx-2"></span>
                <span class="small text-body-secondary">선택된 양식:
                  <strong id="apprformName" class="text-body">미선택</strong></span>
                <span class="small text-body-secondary">결재선:
                  <strong id="approverNames" class="text-body">미지정</strong></span>
              </div>

              <!-- 제목 -->
              <div class="mb-3">
                <label for="docTitle" class="form-label">제목</label>
                <input type="text" class="form-control" id="docTitle" name="docTitle"
                       placeholder="제목을 입력하세요" maxlength="200" required/>
              </div>

              <!-- 에디터 -->
              <div class="mb-3">
                <label class="form-label">본문</label>
                <div id="editor" style="min-height:560px"></div>
                <div class="form-text">양식 선택 시 본문에 자동 삽입됩니다. 직접 수정 가능합니다.</div>
              </div>

              <!-- 템플릿 표 전용 도구 -->
              <div id="templateTools" class="mt-2 d-none">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-secondary" id="btnAddRow">행 추가</button>
                  <button type="button" class="btn btn-outline-secondary" id="btnDelRow">마지막 행 삭제</button>
                </div>
                <div class="form-text">표 안쪽 셀은 에디터에서 바로 입력하세요. 행 추가/삭제는 버튼으로.</div>
              </div>

              <!-- 첨부 -->
              <div class="mb-3 mt-3">
                <label class="form-label" for="attachments">첨부파일</label>
                <div class="input-group input-group-sm">
                  <input class="form-control" type="file" id="attachments" name="attachments" multiple/>
                  <button type="button" class="btn btn-outline-secondary" id="btnClearFiles">비우기</button>
                </div>
                <div class="form-text" id="selectedFilesHelp">선택된 파일 없음</div>
              </div>

              <!-- 액션 -->
              <div class="d-flex justify-content-end gap-2 pt-2">
                <button type="reset" class="btn btn-secondary">초기화</button>
                <button type="submit" class="btn btn-primary">제출</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 우측 메타 -->
        <div class="col-12 col-xl-3">
          <div class="card">
            <div class="card-header py-2"><strong>문서 정보</strong></div>
            <div class="card-body small">
              <dl class="row mb-0">
                <dt class="col-4">기안자</dt><dd class="col-8">-</dd>
                <dt class="col-4">부서</dt><dd class="col-8">-</dd>
                <dt class="col-4">작성일</dt><dd class="col-8" th:text="${#dates.format(#dates.createNow(),'yyyy-MM-dd HH:mm')}">-</dd>
              </dl>
              <hr/>
              <div class="text-body-secondary">제출 후 수신함(진행)에서 결재 상태를 확인할 수 있습니다.</div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- ===== 양식 선택 Modal ===== -->
  <div class="modal fade" id="formSelectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">결재 양식 선택</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive border rounded">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
              <tr><th style="width:60px">선택</th><th>양식명</th><th style="width:180px">분류</th></tr>
              </thead>
              <tbody>
                <!-- 데모용 더미. 실제에선 서버목록 바인딩 -->
                <tr>
                  <td><button type="button" class="btn btn-outline-primary btn-sm"
                              data-id="AF001" data-name="지출결의서" onclick="handleSelectForm(this)">선택</button></td>
                  <td>지출결의서</td><td>일반</td>
                </tr>
                <tr>
                  <td><button type="button" class="btn btn-outline-primary btn-sm"
                              data-id="AF002" data-name="공사계약서(간이형)" onclick="handleSelectForm(this)">선택</button></td>
                  <td>공사계약서(간이형)</td><td>계약</td>
                </tr>
                <tr>
                  <td><button type="button" class="btn btn-outline-primary btn-sm"
                              data-id="AF003" data-name="공사계약서(상세형)" onclick="handleSelectForm(this)">선택</button></td>
                  <td>공사계약서(상세형)</td><td>계약</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button></div>
      </div>
    </div>
  </div>

  <!-- ===== 결재선 지정 Modal (간이) ===== -->
  <div class="modal fade" id="apprLineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">결재선 지정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <!-- 좌측: 부서/사원 목록은 실제 연동 시 서버 데이터로 교체 -->
          <div class="table-responsive border rounded">
            <table class="table table-sm mb-0" id="empTable">
              <thead class="table-light"><tr><th>선택</th><th>이름</th><th>직급</th></tr></thead>
              <tbody>
                <tr><td><button type="button" class="btn btn-outline-primary btn-sm" onclick="addApprover('EMP001','홍길동')">추가</button></td><td>홍길동</td><td>대리</td></tr>
                <tr><td><button type="button" class="btn btn-outline-primary btn-sm" onclick="addApprover('EMP002','김대리')">추가</button></td><td>김대리</td><td>과장</td></tr>
              </tbody>
            </table>
          </div>

          <hr class="my-3"/>

          <!-- 선택된 결재선 -->
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0">선택된 결재선</h6>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-outline-secondary" onclick="moveApprover(-1)">위로</button>
              <button type="button" class="btn btn-outline-secondary" onclick="moveApprover(1)">아래로</button>
              <button type="button" class="btn btn-outline-danger" onclick="removeSelectedApprover()">삭제</button>
            </div>
          </div>
          <div class="table-responsive border rounded">
            <table class="table table-sm align-middle mb-0" id="apprLineTable">
              <thead class="table-light"><tr><th style="width:50px">#</th><th style="width:60px">선택</th><th>결재자</th><th style="width:180px">역할</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button class="btn btn-primary" onclick="applyApproverLine()" data-bs-dismiss="modal">적용</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== 페이지 전용 스크립트 =====
       ※ CoreUI/Bootstrap/ToastUI Editor 로드는 fragments/scripts.html 등 공용에서 처리한다고 가정 -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    /** ----- Toast UI Editor 초기화 ----- */
    let editor;
    function fixEditorScrollX(){
      requestAnimationFrame(()=>{
        document.querySelector(".toastui-editor-ww-container .toastui-editor-ww-scroll")
          ?.style.setProperty("overflow-x","auto","important");
      });
    }
    document.addEventListener("DOMContentLoaded", () => {
      if (!window.toastui || !toastui.Editor) {
        console.warn("toastui Editor가 로드되지 않았습니다. fragments/scripts.html에서 CDN을 포함하세요.");
        return;
      }
      editor = new toastui.Editor({
        el: document.querySelector("#editor"),
        height: "560px",
        initialEditType: "wysiwyg",
        previewStyle: "vertical",
        initialValue: "",
        usageStatistics: false
      });
      fixEditorScrollX();

      // 제출 검증 + HTML 싱크
      document.getElementById("approvalForm").addEventListener("submit", (e) => {
        const title = document.getElementById("docTitle").value.trim();
        const approvers = document.getElementById("approverIds").value;
        const formId = document.getElementById("apprformId").value;
        if (!title){ e.preventDefault(); return alert("제목을 입력하세요."); }
        if (!formId){ e.preventDefault(); return alert("결재 양식을 선택하세요."); }
        if (!approvers){ e.preventDefault(); return alert("최소 1명의 결재자를 지정하세요."); }
        document.getElementById("docHtml").value = editor.getHTML();
      });

      // Reset
      document.getElementById("approvalForm").addEventListener("reset", () => {
        editor.setHTML("");
        toggleTemplateTools(false);
        document.getElementById("apprformId").value = "";
        document.getElementById("apprformName").textContent = "미선택";
        document.getElementById("approverIds").value = "";
        document.getElementById("approverNames").textContent = "미지정";
        document.querySelector("#apprLineTable tbody").innerHTML = "";
        line.length = 0; selectedIndex = -1;
        fixEditorScrollX();
      });

      // 첨부 미니 UX
      const fileInput = document.getElementById("attachments");
      const help = document.getElementById("selectedFilesHelp");
      const clearBtn = document.getElementById("btnClearFiles");
      if (fileInput && help && clearBtn){
        fileInput.addEventListener("change", () => {
          help.textContent = fileInput.files.length
            ? Array.from(fileInput.files).map(f => f.name).join(", ")
            : "선택된 파일 없음";
        });
        clearBtn.addEventListener("click", () => { fileInput.value = ""; help.textContent = "선택된 파일 없음"; });
      }

      // 표 템플릿 도구 버튼
      document.getElementById("btnAddRow")?.addEventListener("click", addTemplateRow);
      document.getElementById("btnDelRow")?.addEventListener("click", removeLastTemplateRow);
    });

    /** ----- 양식 템플릿 삽입 (지출/계약) ----- */
    function setTemplateScope(scope){
      const root = document.querySelector(".toastui-editor-contents");
      if (!root) return;
      root.classList.remove("tpl-cost","tpl-contract");
      if (scope === "cost") root.classList.add("tpl-cost");
      if (scope === "contract") root.classList.add("tpl-contract");
    }
    function docWrap(inner){ return `<div class="t-doc">${inner}</div>`; }

    function getCostSheetTemplate(rowCount = 20){
      const headers = ["순번","공정","구분","일자","업체명","품명","규격","단위","수량","재료단가","재료금액","노무단가","노무금액","경비단가","경비금액","합계단가","합계금액","비고"];
      const numericIdx = new Set([8,9,10,11,12,13,14,15,16]);
      const wrapIdx = new Set([4,5,6,17]);
      const colgroup = `<colgroup>${headers.map((_,i)=>`<col style="width:${i===0?60:(numericIdx.has(i)?96:120)}px;min-width:${i===0?60:(numericIdx.has(i)?96:120)}px">`).join("")}</colgroup>`;
      const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
      let tbody = "<tbody>";
      for(let r=1;r<=rowCount;r++){
        const tds = headers.map((_,ci)=>{
          const align = numericIdx.has(ci) ? "text-align:right;" : (ci===0 ? "text-align:center;" : "");
          const cls = wrapIdx.has(ci) ? ' class="t-wrap"' : "";
          return `<td style="${align}"${cls}>${ci===0?r:""}</td>`;
        }).join("");
        tbody += `<tr>${tds}</tr>`;
      }
      tbody += "</tbody>";
      return `
<p class="t-form-title" style="font-weight:700;margin:4px 0 8px;">지출결의서</p>
<div class="t-scroll">
  <table data-template="cost-sheet">${colgroup}${thead}${tbody}</table>
</div>
<p class="text-secondary" style="font-size:12px;margin-top:8px;">※ 2행은 항목 헤더, 3행부터 입력 행입니다. 숫자 칸은 오른쪽 정렬됩니다.</p>`;
    }
    function getContractSimple(){
      return `
<h2 style="text-align:center; margin:8px 0 16px;">공사계약서</h2>
<table class="contract-table"><tbody>
<tr><th style="width:18%;">공사명</th><td>[공사명]</td><th style="width:18%;">공사면적</th><td>[면적]</td></tr>
<tr><th>공사장소</th><td>[주소]</td><th>공사기간</th><td>[착수일] ~ [준공일]</td></tr>
</tbody></table>`; // 상세 조항은 필요 시 추가 삽입
    }
    function getContractDetailed(){
      return `
<h2 style="text-align:center; margin:8px 0 16px;">공사 계약서</h2>
<p class="muted">※ 빈칸을 채워 계약 내용을 확정하세요.</p>
<table class="contract-table"><tbody>
<tr><th style="width:18%;">공사명</th><td>[ ]</td><th style="width:18%;">공사기간</th><td>[착수] ~ [완료]</td></tr>
<tr><th>공사장소</th><td colspan="3">[ ]</td></tr>
</tbody></table>`;
    }

    function handleSelectForm(btn){
      const id = btn.getAttribute("data-id");
      const name = btn.getAttribute("data-name");
      document.getElementById("apprformId").value = id;
      document.getElementById("apprformName").textContent = name;

      if (!editor) return;
      // 양식 종류별 템플릿 삽입
      if (id === "AF001"){ // 지출결의서
        setTemplateScope("cost");
        editor.setHTML(getCostSheetTemplate(20));
        toggleTemplateTools(true);
      } else if (id === "AF002"){ // 계약 간이형
        setTemplateScope("contract");
        editor.setHTML(docWrap(getContractSimple()));
        toggleTemplateTools(false);
      } else { // AF003 계약 상세형
        setTemplateScope("contract");
        editor.setHTML(docWrap(getContractDetailed()));
        toggleTemplateTools(false);
      }
      fixEditorScrollX();
    }

    /** ----- 표 행 추가/삭제 ----- */
    function findTemplateTable(){
      const c = document.querySelector(".toastui-editor-contents");
      return c?.querySelector('table[data-template="cost-sheet"]');
    }
    function addTemplateRow(){
      const t = findTemplateTable(); if (!t) return;
      const lastIndex = t.tBodies[0]?.rows.length || 0;
      const cols = t.tHead.rows[0].cells.length;
      const numericIdx = new Set([8,9,10,11,12,13,14,15,16]);
      const wrapIdx = new Set([4,5,6,17]);
      const tr = document.createElement("tr");
      for (let ci=0; ci<cols; ci++){
        const td = document.createElement("td");
        if (ci===0){ td.style.textAlign="center"; td.textContent = String(lastIndex+1); }
        else if (numericIdx.has(ci)){ td.style.textAlign="right"; }
        if (wrapIdx.has(ci)) td.classList.add("t-wrap");
        tr.appendChild(td);
      }
      t.tBodies[0].appendChild(tr);
    }
    function removeLastTemplateRow(){
      const t = findTemplateTable(); if (!t) return;
      const body = t.tBodies[0]; if (!body || !body.rows.length) return;
      body.deleteRow(body.rows.length-1);
    }
    function toggleTemplateTools(show){
      document.getElementById("templateTools").classList.toggle("d-none", !show);
    }

    /** ----- 결재선 관리 ----- */
    const line = []; // [{id,name,role}]
    let selectedIndex = -1;
    function renderLine(){
      const tbody = document.querySelector("#apprLineTable tbody");
      tbody.innerHTML = line.map((u,idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td><input type="radio" name="pickLine" ${idx===selectedIndex?"checked":""} onclick="selectedIndex=${idx}"></td>
          <td>${u.name}</td>
          <td>
            <select class="form-select form-select-sm" onchange="line[${idx}].role=this.value">
              <option value="APPROVER" ${u.role==="APPROVER"?"selected":""}>결재</option>
              <option value="AGREE" ${u.role==="AGREE"?"selected":""}>합의</option>
              <option value="CC" ${u.role==="CC"?"selected":""}>참조</option>
            </select>
          </td>
        </tr>`).join("");
    }
    function addApprover(id,name){ line.push({id,name,role:"APPROVER"}); renderLine(); }
    function moveApprover(delta){
      if (selectedIndex<0) return;
      const ni = selectedIndex + delta;
      if (ni<0 || ni>=line.length) return;
      [line[selectedIndex], line[ni]] = [line[ni], line[selectedIndex]];
      selectedIndex = ni; renderLine();
    }
    function removeSelectedApprover(){
      if (selectedIndex<0) return;
      line.splice(selectedIndex,1); selectedIndex = -1; renderLine();
    }
    function applyApproverLine(){
      document.getElementById("approverIds").value = line.map(x=>x.id).join(",");
      document.getElementById("approverNames").textContent = line.map((x,i)=>`${i+1}.${x.name}`).join(" > ") || "미지정";
    }
    /*]]>*/
  </script>

  <!-- 페이지 한정 CSS(원본의 .tpl-cost / .tpl-contract 핵심만 발췌)
       ※ 정식에선 fragments/head 또는 별도 CSS로 이동 권장 -->
  <style>
    .toastui-editor-defaultUI{ border:1px solid #e9ecef !important; border-radius:.5rem; }
    .toastui-editor-defaultUI .toastui-editor-toolbar,
    .toastui-editor-defaultUI .toastui-editor-main-container{ border:0 !important; }
    .toastui-editor-ww-container .toastui-editor-ww-scroll{ overflow-x:auto !important; }
    /* 지출결의서 스코프 */
    .toastui-editor-contents.tpl-cost .t-scroll{ display:block; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .toastui-editor-contents.tpl-cost .t-scroll > table{
      width:max-content; min-width:1880px; border-collapse:collapse; table-layout:fixed; font-size:14px;
    }
    .toastui-editor-contents.tpl-cost .t-scroll thead th{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.2; font-size:13px;
      padding:6px 8px; background:#495057; color:#fff; text-align:center; border:1px solid #dee2e6;
    }
    .toastui-editor-contents.tpl-cost .t-scroll tbody td{
      padding:6px 8px; vertical-align:middle; border:1px solid #e9ecef; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toastui-editor-contents.tpl-cost .t-scroll td.t-wrap,
    .toastui-editor-contents.tpl-cost .t-scroll td.t-wrap *{
      white-space:normal !important; overflow-wrap:break-word !important; overflow:visible; text-overflow:clip;
    }
    /* 계약서 스코프 */
    .toastui-editor-contents.tpl-contract .t-doc{ max-width:190mm; margin:0 auto; padding:0 8px; }
    .toastui-editor-contents.tpl-contract .contract-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-bottom:8px; }
    .toastui-editor-contents.tpl-contract .contract-table th,
    .toastui-editor-contents.tpl-contract .contract-table td{ border:1px solid #e9ecef; padding:6px 8px; }
    .toastui-editor-contents.tpl-contract .contract-table th{ background:#f8f9fa; text-align:left; }
  </style>
</section>
</html>
